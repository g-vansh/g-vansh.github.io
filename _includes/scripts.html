<!-- Academic Kinetic Motion Engine Dependencies -->
<script src="https://cdn.jsdelivr.net/gh/studio-freight/lenis@1.0.29/bundled/lenis.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
<script>
  if (!window.__threeReady) {
    window.__threeReady = new Promise((resolve, reject) => {
      window.__resolveThreeReady = resolve;
      window.__rejectThreeReady = reject;
    });
  }
</script>
<script type="module">
  const localThreeModuleUrl = '{{ base_path }}/assets/js/vendor/three.module.js';
  const cdnThreeModuleUrl = 'https://unpkg.com/three@0.159.0/build/three.module.js';

  async function resourceAvailable(url) {
    try {
      const response = await fetch(url, { method: 'HEAD', cache: 'no-store' });
      return response.ok;
    } catch (error) {
      return false;
    }
  }

  async function loadThreeModule() {
    let moduleUrl = localThreeModuleUrl;
    const hasLocalModule = await resourceAvailable(localThreeModuleUrl);

    if (!hasLocalModule) {
      console.warn('Local Three.js module missing. Loading CDN build instead.');
      moduleUrl = cdnThreeModuleUrl;
    }

    const THREE = await import(moduleUrl);
    window.THREE = THREE;
    window.dispatchEvent(new CustomEvent('three:ready', { detail: { THREE } }));
    return THREE;
  }

  loadThreeModule()
    .then((THREE) => {
      if (window.__resolveThreeReady) {
        window.__resolveThreeReady(THREE);
      }
    })
    .catch((error) => {
      console.error('Three.js module initialization failed.', error);
      if (window.__rejectThreeReady) {
        window.__rejectThreeReady(error);
      }
    });
</script>
<script nomodule src="{{ base_path }}/assets/js/vendor/three.min.js"></script>

<script src="{{ base_path }}/assets/js/main.min.js"></script>
<script src="{{ base_path }}/assets/js/motion-core.js"></script>
<script src="{{ base_path }}/assets/js/three-background.js"></script>
<script src="{{ base_path }}/assets/js/hero-animation.js"></script>
<script src="{{ base_path }}/assets/js/mobile-menu.js"></script>
<script src="{{ base_path }}/assets/js/affiliations.js"></script>

<!-- Leaflet Map Library -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>

<!-- Custom Scripts -->
{% if page.mathjax %}
<script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
{% endif %}

<!-- Leaflet MarkerCluster Plugin -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

<script src="{{ base_path }}/assets/js/research-map.js"></script>
<script src="{{ base_path }}/assets/js/research-stats.js"></script>

{% include analytics.html %}
{% include /comments-providers/scripts.html %}
