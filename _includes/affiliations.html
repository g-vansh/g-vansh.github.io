<div class="affiliations-container" id="affiliations-container">
  <div class="affiliations-header">
    <h3>Affiliations</h3>
    <button class="affiliations-toggle" id="affiliations-toggle" aria-label="Toggle affiliations display">
      <i class="fas fa-university"></i>
      <span class="toggle-text">View Affiliations</span>
      <i class="fas fa-chevron-down toggle-arrow"></i>
    </button>
  </div>
  
  <div class="affiliations-content" id="affiliations-content">
    <div class="affiliations-grid">
      {% assign sorted_affiliations = site.data.affiliations.affiliations | sort: 'order' %}
      {% for affiliation in sorted_affiliations %}
        {% assign affiliation_page = site.affiliations | where: 'slug', affiliation.description_file | first %}
        <a href="{{ affiliation_page.url | relative_url }}" class="affiliation-link">
          <div class="affiliation-item {{ affiliation.type }}" 
               data-affiliation="{{ affiliation.id }}"
               data-tooltip-content="{{ affiliation_page.content | strip_html | truncatewords: 30, '...' }} Click to read more â†’"
               role="button"
               tabindex="0"
               aria-label="Learn more about {{ affiliation.name }}"
               title="{{ affiliation.name }}">
          
          <div class="affiliation-logo">
            {% if affiliation.logo %}
              <img src="{{ affiliation.logo | relative_url }}" 
                   alt="{{ affiliation.logo_alt }}" 
                   loading="lazy"
                   onerror="this.style.display='none';">
            {% else %}
              <div class="affiliation-logo-fallback">
                <i class="fas fa-university" aria-hidden="true"></i>
                <span class="affiliation-short-name">{{ affiliation.short_name }}</span>
              </div>
            {% endif %}
          </div>
          
          <div class="affiliation-info">
            <h3 class="affiliation-name">{{ affiliation.name }}</h3>
            <span class="affiliation-type-badge {{ affiliation.type }}">
              {{ affiliation.type | capitalize }}
            </span>
          </div>
        </div>
        </a>
      {% endfor %}
    </div>
    
    <!-- Modal for detailed information -->
    <div class="affiliation-modal" id="affiliation-modal" role="dialog" aria-hidden="true" aria-labelledby="modal-title">
      <div class="modal-backdrop" id="modal-backdrop"></div>
      <div class="modal-content" role="document">
        <div class="modal-header">
          <h2 id="modal-title"><!-- Dynamic title --></h2>
          <button class="modal-close" id="modal-close" aria-label="Close modal">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body" id="modal-body">
          <!-- Dynamic content -->
        </div>
        <div class="modal-footer">
          <a href="#" id="modal-website-link" class="btn btn--primary" target="_blank" rel="noopener noreferrer">
            <i class="fas fa-external-link-alt"></i>
            Visit Website
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Preload affiliation content -->
<script type="application/json" id="affiliations-data">
{
  {% for affiliation in sorted_affiliations %}
  "{{ affiliation.id }}": {
    "name": "{{ affiliation.name | escape }}",
    "website": "{{ affiliation.website }}",
    "content": {% assign found = false %}{% for doc in site.affiliations %}{% capture doc_slug %}{{ doc.path | split: "/" | last | split: "." | first }}{% endcapture %}{% if doc_slug == affiliation.description_file %}{{ doc.content | markdownify | jsonify }}{% assign found = true %}{% break %}{% endif %}{% endfor %}{% unless found %}null{% endunless %}
  }{% unless forloop.last %},{% endunless %}
  {% endfor %}
}
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const affiliationsContainer = document.getElementById('affiliations-container');
  const affiliationsToggle = document.getElementById('affiliations-toggle');
  const affiliationsContent = document.getElementById('affiliations-content');
  const toggleArrow = affiliationsToggle.querySelector('.toggle-arrow');
  const toggleText = affiliationsToggle.querySelector('.toggle-text');
  
  const modal = document.getElementById('affiliation-modal');
  const modalTitle = document.getElementById('modal-title');
  const modalBody = document.getElementById('modal-body');
  const modalClose = document.getElementById('modal-close');
  const modalBackdrop = document.getElementById('modal-backdrop');
  const modalWebsiteLink = document.getElementById('modal-website-link');
  
  const affiliationItems = document.querySelectorAll('.affiliation-item');
  const affiliationsData = JSON.parse(document.getElementById('affiliations-data').textContent);
  
  let isExpanded = false;
  
  // Toggle affiliations display
  function toggleAffiliations() {
    isExpanded = !isExpanded;
    
    if (isExpanded) {
      affiliationsContent.style.maxHeight = affiliationsContent.scrollHeight + 'px';
      affiliationsContent.style.opacity = '1';
      affiliationsContainer.classList.add('expanded');
      toggleArrow.style.transform = 'rotate(180deg)';
      toggleText.textContent = 'Hide Affiliations';
    } else {
      affiliationsContent.style.maxHeight = '0';
      affiliationsContent.style.opacity = '0';
      affiliationsContainer.classList.remove('expanded');
      toggleArrow.style.transform = 'rotate(0deg)';
      toggleText.textContent = 'View Affiliations';
    }
  }
  
  // Open modal with affiliation details
  function openModal(affiliationId) {
    const data = affiliationsData[affiliationId];
    if (!data) return;
    
    modalTitle.textContent = data.name;
    modalWebsiteLink.href = data.website;
    
    // Load content from markdown (already converted to HTML by Jekyll)
    if (data.content && data.content !== null) {
      modalBody.innerHTML = data.content;
    } else {
      modalBody.innerHTML = '<p>No detailed information available for this affiliation.</p>';
    }
    
    modal.style.display = 'flex';
    modal.setAttribute('aria-hidden', 'false');
    document.body.style.overflow = 'hidden';
    
    // Focus management
    modalClose.focus();
  }
  
  // Close modal
  function closeModal() {
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = '';
  }
  
  // Event listeners
  affiliationsToggle.addEventListener('click', toggleAffiliations);
  
  affiliationItems.forEach(item => {
    // Click event for modal
    item.addEventListener('click', () => {
      const affiliationId = item.getAttribute('data-affiliation');
      if (!isExpanded) {
        toggleAffiliations();
        setTimeout(() => openModal(affiliationId), 300);
      } else {
        openModal(affiliationId);
      }
    });
    
    // Keyboard navigation
    item.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        item.click();
      }
    });
  });
  
  modalClose.addEventListener('click', closeModal);
  modalBackdrop.addEventListener('click', closeModal);
  
  // Keyboard navigation
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modal.style.display === 'flex') {
      closeModal();
    }
  });
});
</script>