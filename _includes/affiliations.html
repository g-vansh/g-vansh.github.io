<div class="affiliations-container" id="affiliations-container">
  <div class="affiliations-header">
    <h3>Affiliations</h3>
    <button class="affiliations-toggle" id="affiliations-toggle" aria-label="Toggle affiliations display">
      <i class="fas fa-university"></i>
      <span class="toggle-text">View Affiliations</span>
      <i class="fas fa-chevron-down toggle-arrow"></i>
    </button>
  </div>
  
  <div class="affiliations-content" id="affiliations-content">
    <div class="affiliations-grid">
      {% assign sorted_affiliations = site.data.affiliations.affiliations | sort: 'order' %}
      {% for affiliation in sorted_affiliations %}
        <div class="affiliation-item {{ affiliation.type }}" 
             data-affiliation="{{ affiliation.id }}"
             role="button"
             tabindex="0"
             aria-label="Learn more about {{ affiliation.name }}"
             aria-describedby="tooltip-{{ affiliation.id }}">
          
          <div class="affiliation-logo">
            {% if affiliation.logo %}
              <img src="{{ affiliation.logo | relative_url }}" 
                   alt="{{ affiliation.logo_alt }}" 
                   loading="lazy"
                   onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
              <div class="logo-fallback" style="display: none;">
                <i class="fas fa-university"></i>
                <span>{{ affiliation.short_name }}</span>
              </div>
            {% else %}
              <div class="logo-fallback">
                <i class="fas fa-university"></i>
                <span>{{ affiliation.short_name }}</span>
              </div>
            {% endif %}
          </div>
          
          <div class="affiliation-info">
            <h4 class="affiliation-name">{{ affiliation.short_name }}</h4>
            <div class="affiliation-type-badge">{{ affiliation.type | capitalize }}</div>
          </div>
          
          <!-- Rich tooltip with markdown content -->
          <div class="affiliation-tooltip" id="tooltip-{{ affiliation.id }}" role="tooltip" aria-hidden="true">
            <div class="tooltip-arrow"></div>
            <div class="tooltip-content">
              {% assign found = false %}
              {% for doc in site.affiliations %}
                {% capture doc_slug %}{{ doc.path | split: "/" | last | split: "." | first }}{% endcapture %}
                {% if doc_slug == affiliation.description_file %}
                  <div class="tooltip-header">
                    <h5>{{ affiliation.name }}</h5>
                    <span class="tooltip-type-badge {{ affiliation.type }}">{{ affiliation.type | capitalize }}</span>
                  </div>
                  <div class="tooltip-body">
                    {{ doc.content | markdownify | truncatewords: 50 }}
                    <div class="tooltip-actions">
                      <span class="tooltip-hint">Click for full details</span>
                    </div>
                  </div>
                  {% assign found = true %}
                  {% break %}
                {% endif %}
              {% endfor %}
              {% unless found %}
                <div class="tooltip-header">
                  <h5>{{ affiliation.name }}</h5>
                  <span class="tooltip-type-badge {{ affiliation.type }}">{{ affiliation.type | capitalize }}</span>
                </div>
                <div class="tooltip-body">
                  <p>Click to learn more about this affiliation.</p>
                </div>
              {% endunless %}
            </div>
          </div>
          
        </div>
      {% endfor %}
    </div>
    
    <!-- Modal for detailed information -->
    <div class="affiliation-modal" id="affiliation-modal" role="dialog" aria-hidden="true" aria-labelledby="modal-title">
      <div class="modal-backdrop" id="modal-backdrop"></div>
      <div class="modal-content" role="document">
        <div class="modal-header">
          <h2 id="modal-title"><!-- Dynamic title --></h2>
          <button class="modal-close" id="modal-close" aria-label="Close modal">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body" id="modal-body">
          <!-- Dynamic content -->
        </div>
        <div class="modal-footer">
          <a href="#" id="modal-website-link" class="btn btn--primary" target="_blank" rel="noopener noreferrer">
            <i class="fas fa-external-link-alt"></i>
            Visit Website
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Preload affiliation content -->
<script type="application/json" id="affiliations-data">
{
  {% for affiliation in sorted_affiliations %}
  "{{ affiliation.id }}": {
    "name": "{{ affiliation.name | escape }}",
    "website": "{{ affiliation.website }}",
    "content": {% assign found = false %}{% for doc in site.affiliations %}{% capture doc_slug %}{{ doc.path | split: "/" | last | split: "." | first }}{% endcapture %}{% if doc_slug == affiliation.description_file %}{{ doc.content | markdownify | jsonify }}{% assign found = true %}{% break %}{% endif %}{% endfor %}{% unless found %}null{% endunless %}
  }{% unless forloop.last %},{% endunless %}
  {% endfor %}
}
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const affiliationsContainer = document.getElementById('affiliations-container');
  const affiliationsToggle = document.getElementById('affiliations-toggle');
  const affiliationsContent = document.getElementById('affiliations-content');
  const toggleArrow = affiliationsToggle.querySelector('.toggle-arrow');
  const toggleText = affiliationsToggle.querySelector('.toggle-text');
  
  const modal = document.getElementById('affiliation-modal');
  const modalTitle = document.getElementById('modal-title');
  const modalBody = document.getElementById('modal-body');
  const modalClose = document.getElementById('modal-close');
  const modalBackdrop = document.getElementById('modal-backdrop');
  const modalWebsiteLink = document.getElementById('modal-website-link');
  
  const affiliationItems = document.querySelectorAll('.affiliation-item');
  const affiliationsData = JSON.parse(document.getElementById('affiliations-data').textContent);
  const tooltips = document.querySelectorAll('.affiliation-tooltip');
  
  let isExpanded = false;
  let currentTooltip = null;
  
  // Toggle affiliations display
  function toggleAffiliations() {
    isExpanded = !isExpanded;
    
    if (isExpanded) {
      affiliationsContent.style.maxHeight = affiliationsContent.scrollHeight + 'px';
      affiliationsContent.style.opacity = '1';
      affiliationsContainer.classList.add('expanded');
      toggleArrow.style.transform = 'rotate(180deg)';
      toggleText.textContent = 'Hide Affiliations';
    } else {
      affiliationsContent.style.maxHeight = '0';
      affiliationsContent.style.opacity = '0';
      affiliationsContainer.classList.remove('expanded');
      toggleArrow.style.transform = 'rotate(0deg)';
      toggleText.textContent = 'View Affiliations';
    }
  }
  
  // Open modal with affiliation details
  function openModal(affiliationId) {
    const data = affiliationsData[affiliationId];
    if (!data) return;
    
    modalTitle.textContent = data.name;
    modalWebsiteLink.href = data.website;
    
    // Load content from markdown (already converted to HTML by Jekyll)
    if (data.content && data.content !== null) {
      modalBody.innerHTML = data.content;
    } else {
      modalBody.innerHTML = '<p>No detailed information available for this affiliation.</p>';
    }
    
    modal.style.display = 'flex';
    modal.setAttribute('aria-hidden', 'false');
    document.body.style.overflow = 'hidden';
    
    // Focus management
    modalClose.focus();
  }
  
  // Close modal
  function closeModal() {
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = '';
  }
  
  // Tooltip functionality
  function showTooltip(item) {
    const affiliationId = item.getAttribute('data-affiliation');
    const tooltip = document.getElementById(`tooltip-${affiliationId}`);
    
    if (tooltip && isExpanded) {
      // Hide any currently visible tooltip
      hideTooltip();
      
      // Position tooltip
      positionTooltip(item, tooltip);
      
      // Show tooltip
      tooltip.style.display = 'block';
      tooltip.setAttribute('aria-hidden', 'false');
      
      // Add delay for smooth transition
      setTimeout(() => {
        tooltip.classList.add('visible');
      }, 10);
      
      currentTooltip = tooltip;
    }
  }
  
  function hideTooltip() {
    if (currentTooltip) {
      currentTooltip.classList.remove('visible');
      setTimeout(() => {
        if (currentTooltip) {
          currentTooltip.style.display = 'none';
          currentTooltip.setAttribute('aria-hidden', 'true');
          currentTooltip = null;
        }
      }, 200);
    }
  }
  
  function positionTooltip(item, tooltip) {
    const itemRect = item.getBoundingClientRect();
    const tooltipRect = tooltip.getBoundingClientRect();
    const viewportWidth = window.innerWidth;
    const viewportHeight = window.innerHeight;
    
    // Reset positioning
    tooltip.style.left = '';
    tooltip.style.right = '';
    tooltip.style.top = '';
    tooltip.style.bottom = '';
    tooltip.classList.remove('tooltip-left', 'tooltip-right', 'tooltip-top', 'tooltip-bottom');
    
    // Try to position tooltip to the right first
    let tooltipLeft = itemRect.right + 15;
    let tooltipTop = itemRect.top + (itemRect.height / 2) - (tooltipRect.height / 2);
    
    // Check if tooltip fits on the right
    if (tooltipLeft + tooltipRect.width > viewportWidth - 20) {
      // Position to the left
      tooltipLeft = itemRect.left - tooltipRect.width - 15;
      tooltip.classList.add('tooltip-left');
      
      // If it doesn't fit on the left either, position above or below
      if (tooltipLeft < 20) {
        tooltipLeft = itemRect.left + (itemRect.width / 2) - (tooltipRect.width / 2);
        
        // Position above
        if (itemRect.top - tooltipRect.height - 15 > 0) {
          tooltipTop = itemRect.top - tooltipRect.height - 15;
          tooltip.classList.add('tooltip-top');
        } else {
          // Position below
          tooltipTop = itemRect.bottom + 15;
          tooltip.classList.add('tooltip-bottom');
        }
      }
    } else {
      tooltip.classList.add('tooltip-right');
    }
    
    // Ensure tooltip stays within viewport bounds
    tooltipLeft = Math.max(20, Math.min(tooltipLeft, viewportWidth - tooltipRect.width - 20));
    tooltipTop = Math.max(20, Math.min(tooltipTop, viewportHeight - tooltipRect.height - 20));
    
    tooltip.style.left = `${tooltipLeft}px`;
    tooltip.style.top = `${tooltipTop}px`;
  }
  
  // Event listeners
  affiliationsToggle.addEventListener('click', toggleAffiliations);
  
  affiliationItems.forEach(item => {
    // Click event for modal
    item.addEventListener('click', () => {
      const affiliationId = item.getAttribute('data-affiliation');
      if (!isExpanded) {
        toggleAffiliations();
        setTimeout(() => openModal(affiliationId), 300);
      } else {
        openModal(affiliationId);
      }
    });
    
    // Hover events for tooltip
    item.addEventListener('mouseenter', () => {
      showTooltip(item);
    });
    
    item.addEventListener('mouseleave', () => {
      hideTooltip();
    });
    
    // Keyboard navigation
    item.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        item.click();
      } else if (e.key === 'Escape') {
        hideTooltip();
      }
    });
    
    // Focus events for keyboard users
    item.addEventListener('focus', () => {
      showTooltip(item);
    });
    
    item.addEventListener('blur', () => {
      hideTooltip();
    });
  });
  
  modalClose.addEventListener('click', closeModal);
  modalBackdrop.addEventListener('click', closeModal);
  
  // Keyboard navigation
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modal.style.display === 'flex') {
      closeModal();
    } else if (e.key === 'Escape') {
      hideTooltip();
    }
  });
  
  // Hide tooltip when clicking outside
  document.addEventListener('click', (e) => {
    if (currentTooltip && !e.target.closest('.affiliation-item') && !e.target.closest('.affiliation-tooltip')) {
      hideTooltip();
    }
  });
  
  // Initialize with collapsed state
  affiliationsContent.style.maxHeight = '0';
  affiliationsContent.style.opacity = '0';
});
</script>